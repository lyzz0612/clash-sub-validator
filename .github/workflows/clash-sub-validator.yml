name: Clash Node Validator

on:
  # å®šæ—¶è¿è¡Œ - æ¯å¤© 8:00 å’Œ 20:00 (UTC+8: 16:00, 04:00)
  schedule:
    - cron: '0 8,20 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      max_latency:
        description: 'æœ€å¤§å»¶è¿Ÿé˜ˆå€¼(æ¯«ç§’)'
        required: false
        default: '3000'
        type: string
      output_file:
        description: 'è¾“å‡ºæ–‡ä»¶å'
        required: false
        default: 'clash_config.yaml'
        type: string

jobs:
  test-clash-nodes:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install aiohttp PyYAML
        
    - name: Create config file if not exists
      run: |
        if [ ! -f config.txt ]; then
          echo "# åœ¨è¿™é‡Œæ·»åŠ ä½ çš„Clashè®¢é˜…é“¾æ¥" > config.txt
          echo "# https://example.com/clash?date=%D" >> config.txt
        fi
        
    - name: Run clash node tester
      env:
        CONFIG_FILE: config.txt
        MAX_LATENCY: ${{ github.event.inputs.max_latency || '3000' }}
        OUTPUT_FILE: ${{ github.event.inputs.output_file || 'clash_config.yaml' }}
        API_URL: ${{ secrets.API_URL }}
        API_KEY: ${{ secrets.API_KEY }}
      run: |
        python clash_tester.py
        
    - name: Commit and push results
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ·»åŠ ç”Ÿæˆçš„æ–‡ä»¶
        if [ -f clash_config.yaml ]; then
          git add clash_config.yaml
        fi
        
        if [ -f good_nodes.json ]; then
          git add good_nodes.json
        fi
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
        if ! git diff --staged --quiet; then
          # è·å–èŠ‚ç‚¹ç»Ÿè®¡ä¿¡æ¯
          if [ -f good_nodes.json ]; then
            node_count=$(python3 -c "import json; data=json.load(open('good_nodes.json')); print(data['total_count'])")
            avg_latency=$(python3 -c "import json; data=json.load(open('good_nodes.json')); print(f\"{data['average_latency']:.1f}\")")
            commit_msg="ğŸš€ Update clash config - ${node_count} nodes, avg ${avg_latency}ms ($(date '+%Y-%m-%d %H:%M:%S'))"
          else
            commit_msg="ğŸš€ Update clash config - $(date '+%Y-%m-%d %H:%M:%S')"
          fi
          
          git commit -m "$commit_msg"
          git push
          echo "âœ… é…ç½®æ–‡ä»¶å·²æ›´æ–°å¹¶æ¨é€åˆ°ä»“åº“"
        else
          echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°é…ç½®å˜åŒ–ï¼Œè·³è¿‡æäº¤"
        fi